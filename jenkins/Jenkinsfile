def hierabranch="goa"
def codebranch="goa"
pipeline {
   agent {label 'jenkins'}
    parameters {
        choice(choices: 'goa\nprod\nuat\ndev\nsit',  description: 'What environment?', name: 'env')
    }
    stages{
       stage('Preparation'){
         steps{
          script{
                if (params.env=="prod"){
                    hierabranch="master"
                    codebranch="prod"
                } else if (params.env=="uat"){
                    hierabranch="master"
                    codebranch="uat"
                } else if (params.env=="dev"){
                    hierabranch="master"
                    codebranch="dev"
                } else if (params.env=="sit"){ 
                    hierabranch="master"
                    codebranch="sit"
                }//if
                git branch: codebranch, url: 'https://github.com/vbkuzhel/puppetcode.git'
                checkout([$class: 'GitSCM', branches: [[name: "*/${hierabranch}"]], doGenerateSubmoduleConfigurations: false, extensions: [[$class: 'RelativeTargetDirectory', relativeTargetDir: 'puppetcode/hieradata']], submoduleCfg: [], userRemoteConfigs: [[url: 'https://github.com/vbkuzhel/hieradata.git']]])                
                sh '''
                if [ -d /tmp/systemexcelence ];then
                    rm -rf /tmp/systemexcelence
                fi
                    mkdir /tmp/systemexcelence               
                cp -r * /tmp/systemexcelence
                cd /tmp
                tar -czvf systemexcelence.tar.gz systemexcelence
                rm -rf systemexcellence
                if [ ! -d dist ]; then mkdir dist fi
                cp systemexcelence.tar.gz dist/
                rm -f systemexcelence.tar.gz
                ls -l 
                '''
                
//                withEnv(['hierabranch=${hierabranch}']) {
    
          }//script
         }//steps
       }//stage
       stage('scp1'){
           agent {label 'jenkins'}
            steps{
                script{
                    sshagent(['r1jboss']) {
                        sh '''
                        scp  -o StrictHostKeyChecking=no /tmp/dist/systemexcelence.tar.gz r1jboss@localhost:/tmp
                        
                        ssh -o UserKnownHostsFile=/dev/null \
                                                -o StrictHostKeyChecking=no \
                                                ${sys_exc_user}@${node} "cd /tmp/;tar xzvf systemexcelence.tar.gz"
                        ls /tmp                                                
                        '''
                    }//sshagent

                }//script

            }//steps
       }//stage
    }//stages
}//pipeline              

